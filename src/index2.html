<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot ICTU</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, sans-serif;
        }

        body {
            min-height: 100vh;
            background-color: #1a1f2e;
            color: #f3f4f6;
            transition: background 0.3s, color 0.3s;
        }

        body.light-mode {
            background-color: #f3f4f6;
            color: #222;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 18rem;
            background-color: #12151f;
            padding: 1.5rem;
            border-right: 1px solid #374151;
            transition: background 0.3s, color 0.3s;
        }

        body.light-mode .sidebar {
            background-color: #fff;
            border-right: 1px solid #e5e7eb;
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 2rem;
        }

        .sidebar-logo {
            width: 3rem;
            height: 3rem;
            object-fit: contain;
            border-radius: 0.5rem;
        }

        .contact-info {
            font-size: 0.875rem;
        }

        .contact-title {
            font-weight: bold;
        }

        .contact-subtitle {
            color: #9ca3af;
        }

        .contact-list {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            font-size: 0.875rem;
            margin-top: 1.5rem;
        }

        .contact-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .contact-icon {
            color: #60a5fa;
            flex-shrink: 0;
            margin-top: 0.25rem;
        }

        .contact-content {
            flex: 1;
        }

        .contact-label {
            font-weight: 500;
        }

        .contact-value {
            color: #9ca3af;
            margin-top: 0.25rem;
        }

        .contact-link {
            color: #60a5fa;
            text-decoration: none;
        }

        .contact-link:hover {
            text-decoration: underline;
        }

        .reference-list {
            margin-top: 0.5rem;
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        /* Main Chat Area Styles */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background-color: #12151f;
            padding: 1rem;
            border-bottom: 1px solid #374151;
            transition: background 0.3s, color 0.3s;
        }

        body.light-mode .header {
            background-color: #fff;
            border-bottom: 1px solid #e5e7eb;
        }

        .header-content {
            max-width: 1280px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .header-icon-wrapper {
            background-color: rgba(59, 130, 246, 0.1);
            padding: 0.5rem;
            border-radius: 0.5rem;
        }

        .header-icon {
            color: #60a5fa;
        }

        .header-title,
        .header-subtitle {
            transition: color 0.3s;
        }

        body.light-mode .header-title {
            color: #1d4ed8;
        }

        body.light-mode .header-subtitle {
            color: #555;
        }

        .header-title {
            font-size: 1.05rem;
            font-weight: bold;
        }

        /* Messages Area Styles */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .messages-container {
            height: 100%;
            /* Chi·∫øm to√†n b·ªô chi·ªÅu cao c·ªßa .messages */
            overflow-y: auto;
            /* Thanh k√©o xu·∫•t hi·ªán khi n·ªôi dung d√†i h∆°n */
            width: 100%;
            /* Gi·ªØ chi·ªÅu r·ªông t·ªëi ƒëa */
            max-width: 1280px;
            /* Gi·ªõi h·∫°n chi·ªÅu r·ªông t·ªëi ƒëa n·∫øu c·∫ßn */
            margin: 0 auto;
            /* CƒÉn gi·ªØa */
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            /* Kho·∫£ng c√°ch gi·ªØa c√°c tin nh·∫Øn */
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 2rem;
            height: 2rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .bot-avatar {
            background-color: rgba(59, 130, 246, 0.1);
            color: #60a5fa;
        }

        .user-avatar {
            background-color: rgba(34, 197, 94, 0.1);
            color: #4ade80;
        }

        .message-content {
            background-color: #12151f;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            max-width: 80%;
            transition: background 0.3s, color 0.3s;
        }

        body.light-mode .message-content {
            background-color: #fff;
            color: #222;
        }

        .message.user .message-content {
            background-color: #2563eb;
            border-top-right-radius: 0;
            color: #fff;
        }

        body.light-mode .message.user .message-content {
            background-color: #dbeafe;
            color: #1e293b;
        }

        .message-text {
            white-space: pre-wrap;
        }

        /* Related Questions Styles */
        .related-questions {
            background-color: #12151f;
            padding: 1rem;
            border-top: 1px solid #374151;
            transition: background 0.3s, color 0.3s;
        }

        body.light-mode .related-questions {
            background-color: #fff;
            border-top: 1px solid #e5e7eb;
        }

        .related-container {
            max-width: 1280px;
            margin: 0 auto;
        }

        .related-title {
            font-size: 0.875rem;
            font-weight: bold;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .related-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .related-button {
            background-color: #1a1f2e;
            border: none;
            color: #f3f4f6;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.3s, color 0.3s;
        }

        body.light-mode .related-button {
            background-color: #e0e7ef;
            color: #1e293b;
        }

        .related-button:hover {
            background-color: #2a2f3e;
        }

        body.light-mode .related-button:hover {
            background-color: #c7d2fe;
        }

        /* Input Area Styles */
        .input-area {
            background-color: #12151f;
            padding: 1rem;
            border-top: 1px solid #374151;
            transition: background 0.3s, color 0.3s;
        }

        body.light-mode .input-area {
            background-color: #fff;
            border-top: 1px solid #e5e7eb;
        }

        .input-container {
            max-width: 1280px;
            margin: 0 auto;
            display: flex;
            gap: 0.5rem;
        }

        .input-field {
            flex: 1;
            background-color: #1a1f2e;
            border: none;
            color: #f3f4f6;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-size: 1rem;
            transition: background 0.3s, color 0.3s;
        }

        body.light-mode .input-field {
            background-color: #f3f4f6;
            color: #222;
        }

        .input-field:focus {
            outline: none;
            box-shadow: 0 0 0 2px #3b82f6;
        }

        .input-field::placeholder {
            color: #6b7280;
        }

        body.light-mode .input-field::placeholder {
            color: #9ca3af;
        }

        .send-button {
            background-color: #2563eb;
            border: none;
            color: white;
            width: 3rem;
            height: 3rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s;
        }

        body.light-mode .send-button {
            background-color: #1d4ed8;
            color: #fff;
        }

        .send-button:hover {
            background-color: #1d4ed8;
        }

        body.light-mode .send-button:hover {
            background-color: #2563eb;
        }

        /* Th√™m CSS cho ph·∫ßn hi·ªÉn th·ªã session */
        .session-info {
            margin: 10px 0;
            font-size: 14px;
            color: #555;
        }

        #history-container {
            margin: 10px 0;
            padding: 10px;
            background: #f0f0f0;
            border-radius: 5px;
        }

        .session-info select {
            margin-left: 10px;
            padding: 5px;
            border-radius: 5px;
        }

        .session-info {
            margin: 10px 0;
            font-size: 14px;
            color: #555;
        }

        #session-list {
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 5px;
        }

        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 3px;
            margin-bottom: 2px;
        }

        .session-item:hover {
            background-color: #f0f0f0;
        }

        .session-item.selected {
            background-color: #e0e0e0;
        }

        .session-name {
            flex-grow: 1;
        }

        .delete-session {
            background: none;
            border: none;
            color: #ff4444;
            cursor: pointer;
            font-size: 14px;
            padding: 0 5px;
        }

        .delete-session:hover {
            color: #cc0000;
        }

        .rename-session {
            background: none;
            border: none;
            color: #4a90e2;
            cursor: pointer;
            font-size: 14px;
            padding: 0 5px;
        }

        .rename-session:hover {
            color: #357abd;
        }

        /* Rating Styles */
        .rating-buttons {
            display: flex;
            gap: 0.3rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #374151;
            align-items: center;
            transition: all 0.3s ease;
            height: auto;
            opacity: 0.5;
        }

        .message-content:hover .rating-buttons,
        .rating-buttons.active {
            opacity: 1;
        }

        .rating-buttons.submitted {
            opacity: 0.5;
        }

        .rating-buttons.submitted:hover {
            opacity: 1;
        }

        .rating-comment {
            display: none;
            flex: 1;
            gap: 0.3rem;
            margin-left: 0.5rem;
            transition: all 0.3s ease;
        }

        .message-content:hover .rating-comment:not(.submitted),
        .rating-comment.active:not(.submitted) {
            display: flex;
        }

        .rating-button {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            opacity: 0.5;
        }

        .rating-buttons.submitted .rating-button {
            display: none;
        }

        .rating-buttons.submitted .rating-button.selected {
            display: flex;
            opacity: 1;
        }

        /* Additional styles */
        .rating-button.selected {
            opacity: 1;
            transform: scale(1.1);
        }

        .rating-good {
            background-color: rgba(34, 197, 94, 0.1);
            color: #4ade80;
            border-color: #4ade80;
        }

        .rating-good:hover {
            background-color: rgba(34, 197, 94, 0.2);
        }

        .rating-fair {
            background-color: rgba(234, 179, 8, 0.1);
            color: #eab308;
            border-color: #eab308;
        }

        .rating-fair:hover {
            background-color: rgba(234, 179, 8, 0.2);
        }

        .rating-poor {
            background-color: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border-color: #ef4444;
        }

        .rating-poor:hover {
            background-color: rgba(239, 68, 68, 0.2);
        }

        .rating-comment-input {
            flex: 1;
            background-color: #1a1f2e;
            border: 1px solid #374151;
            color: #f3f4f6;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            resize: none;
            height: 24px;
            max-height: 100px;
        }

        .rating-comment-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .rating-submit {
            background-color: #2563eb;
            border: none;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .rating-submit:hover {
            background-color: #1d4ed8;
        }

        .rating-feedback {
            font-size: 0.65rem;
            color: #9ca3af;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rating-feedback-text {
            flex: 1;
        }

        .rating-button:hover {
            transform: translateY(-1px);
        }

        .rating-button:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            padding: 4px 8px;
            background-color: #1a1f2e;
            color: #f3f4f6;
            border-radius: 4px;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 1000;
            border: 1px solid #374151;
        }

        .new-session-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            margin: 10px 0;
            background-color: #2563eb;
            color: #fff;
            border: none;
            border-radius: 9999px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .new-session-btn:hover {
            background-color: #1d4ed8;
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.15);
        }

        /* N√∫t chuy·ªÉn ƒë·ªïi dark/light mode */
        .toggle-mode-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            margin-left: auto;
            margin-right: 0.5rem;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-mode-btn:hover {
            background: #e0e7ef;
        }

        body.dark-mode .toggle-mode-btn:hover {
            background: #23263a;
        }

        /* L√†m icon sun s√°ng m√†u v√†ng trong dark mode, moon x√°m nh·∫°t trong light mode */
        body.dark-mode #toggle-mode-icon[data-lucide="sun"] {
            color: #facc15;
            filter: drop-shadow(0 0 4px #fde68a);
        }

        body.light-mode #toggle-mode-icon[data-lucide="moon"] {
            color: #64748b;
        }

        /* N·ªÅn √¥ nh·∫≠p ƒë√°nh gi√° chuy·ªÉn tr·∫Øng khi light mode */
        body.light-mode .rating-comment-input {
            background-color: #fff;
            color: #222;
            border: 1px solid #e5e7eb;
        }

        body.light-mode .rating-comment-input:focus {
            border-color: #1d4ed8;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="https://ictu.edu.vn/wp-content/uploads/2022/12/logo-co-vien-chu-JPG-scaled.jpg"
                    alt="ICTU Logo" class="sidebar-logo">
                <div class="contact-info">
                    <h2 class="contact-title">Th√¥ng tin li√™n h·ªá</h2>
                    <p class="contact-subtitle">Ph√≤ng C√¥ng t√°c HSSV</p>
                </div>
            </div>

            <div class="contact-list">
                <div class="contact-item">
                    <i class="contact-icon" data-lucide="building-2"></i>
                    <div class="contact-content">
                        <p class="contact-label">Tr∆∞·ªùng ƒê·∫°i h·ªçc C√¥ng ngh·ªá Th√¥ng tin v√† Truy·ªÅn th√¥ng</p>
                        <p class="contact-value">T·∫ßng 2, Nh√† A1</p>
                    </div>
                </div>

                <div class="contact-item">
                    <i class="contact-icon" data-lucide="mail"></i>
                    <a href="mailto:ctsv@ictu.edu.vn" class="contact-link">ctsv@ictu.edu.vn</a>
                </div>

                <div class="contact-item">
                    <i class="contact-icon" data-lucide="phone"></i>
                    <p>0xxx.xxx.xxx</p>
                </div>

                <div class="contact-item">
                    <i class="contact-icon" data-lucide="clock"></i>
                    <div class="contact-content">
                        <p class="contact-label">Gi·ªù l√†m vi·ªác</p>
                        <p class="contact-value">Th·ª© 2 - Th·ª© 6: 8:00 - 17:00</p>
                    </div>
                </div>

                <div class="contact-item">
                    <i class="contact-icon" data-lucide="book-open"></i>
                    <div class="contact-content">
                        <p class="contact-label">T√†i li·ªáu tham kh·∫£o</p>
                        <ul class="reference-list">
                            <li class="contact-value">
                                <i data-lucide="calendar"
                                    style="width: 1rem; height: 1rem; display: inline; vertical-align: middle; margin-right: 0.5rem;"></i>
                                Quy·∫øt ƒë·ªãnh s·ªë 51/Qƒê-ƒêHCNTT&TT
                            </li>
                            <li class="contact-value">
                                <i data-lucide="calendar"
                                    style="width: 1rem; height: 1rem; display: inline; vertical-align: middle; margin-right: 0.5rem;"></i>
                                Quy·∫øt ƒë·ªãnh s·ªë 365/Qƒê-ƒêHCNTT&TT
                            </li>
                            <li class="contact-value">
                                <i data-lucide="globe"
                                    style="width: 1rem; height: 1rem; display: inline; vertical-align: middle; margin-right: 0.5rem;"></i>
                                <a href="http://ictu.edu.vn" class="contact-link">ictu.edu.vn</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="session-info">
                <div id="session-list"></div>
                <button id="new-session" class="new-session-btn">New Conversation</button>
                <div id="history-container" style="display: none;"></div>
            </div>

        </div>

        <!-- Main Chat Area -->
        <div class="main">
            <!-- Header -->
            <header class="header">
                <div class="header-content">

                    <div class="header-icon-wrapper">
                        <i class="header-icon" data-lucide="school"></i>
                    </div>
                    <div>
                        <h1 class="header-title">Chatbot ICTU</h1>
                        <p class="header-subtitle">H·ªèi ƒë√°p th√¥ng tin v·ªÅ h·ªçc b·ªïng, quy ƒë·ªãnh t·∫°i Tr∆∞·ªùng ƒê·∫°i h·ªçc C√¥ng ngh·ªá
                            Th√¥ng tin
                            v√† Truy·ªÅn th√¥ng</p>
                    </div>
                    <button class="toggle-mode-btn" id="toggle-mode-btn" title="Chuy·ªÉn ch·∫ø ƒë·ªô s√°ng/t·ªëi">
                        <i id="toggle-mode-icon" data-lucide="sun"></i>
                    </button>
                </div>
            </header>

            <!-- Messages Area -->
            <div class="messages">
                <div class="messages-container" id="messages-container">
                    <!-- Tin nh·∫Øn s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                </div>
            </div>

            <!-- Related Questions -->
            <div class="related-questions">
                <div class="related-container">
                    <h3 class="related-title">
                        <i data-lucide="book-open" style="width: 1rem; height: 1rem;"></i>
                        C√¢u h·ªèi g·ª£i √Ω
                    </h3>
                    <div class="related-list" id="related-questions">
                        <!-- C√¢u h·ªèi li√™n quan s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                    </div>
                </div>
            </div>

            <!-- Input Area -->
            <form class="input-area" id="chat-form">
                <div class="input-container">
                    <input type="text" class="input-field" placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n..." id="message-input">
                    <button type="submit" class="send-button">
                        <i data-lucide="send"></i>
                    </button>
                </div>
            </form>
        </div>


    </div>

    <script>
        lucide.createIcons();

        const messagesContainer = document.getElementById('messages-container');
        const relatedQuestionsContainer = document.getElementById('related-questions');

        let userId;
        let sessions = JSON.parse(localStorage.getItem('sessions')) || [];
        let sessionNames = JSON.parse(localStorage.getItem('sessionNames')) || {}; //L∆∞u tr·ªØ phi√™n t·∫°i Client
        function saveActive(id) { localStorage.setItem('activeSessionId', id); }
        function getActive() { return localStorage.getItem('activeSessionId'); }

        async function initializeUserId() {
            try {
                if (sessions.length === 0) {
                    const response = await fetch('/get_user_id');
                    if (!response.ok) throw new Error(`L·ªói /get_user_id: ${response.status} - ${await response.text()}`);
                    const data = await response.json();
                    userId = data.user_id;
                    sessions.push(userId);
                    localStorage.setItem('sessions', JSON.stringify(sessions));
                } else {
                    userId = sessions[sessions.length - 1];
                }
                const nameResponse = await fetch(`/get_session_name?user_id=${userId}`);
                if (!nameResponse.ok) throw new Error(`L·ªói /get_session_name: ${nameResponse.status} - ${await nameResponse.text()}`);
                const nameData = await nameResponse.json();
                sessionNames[userId] = nameData.name;
                localStorage.setItem('sessionNames', JSON.stringify(sessionNames));
                return userId;
            } catch (error) {
                console.error('L·ªói trong initializeUserId:', error);
                throw error;
            }
        }

        // H√†m m·ªõi ƒë·ªÉ t·∫£i l·ªãch s·ª≠ v√† hi·ªÉn th·ªã trong #messages-container
        async function loadSessionHistoryIntoChat() {
            try {
                const response = await fetch(`/get_session_history?user_id=${userId}`);
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || 'Kh√¥ng th·ªÉ l·∫•y l·ªãch s·ª≠');
                }
                // X√≥a c√°c tin nh·∫Øn c≈© trong #messages-container
                messagesContainer.innerHTML = '';
                if (data.history && data.history.length > 0) {
                    data.history.forEach(item => {
                        const userMessage = { text: item.question, isBot: false };
                        const botMessage = { text: item.answer, isBot: true };
                        messagesContainer.appendChild(createMessageElement(userMessage));
                        messagesContainer.appendChild(createMessageElement(botMessage));
                    });
                } else {
                    // Hi·ªÉn th·ªã tin nh·∫Øn m·∫∑c ƒë·ªãnh n·∫øu kh√¥ng c√≥ l·ªãch s·ª≠
                    const initialMessage = { text: 'ICTU xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p b·∫°n tr·∫£ l·ªùi c√°c c√¢u h·ªèi v·ªÅ h·ªçc b·ªïng, quy ƒë·ªãnh t·∫°i tr∆∞·ªùng ƒê·∫°i h·ªçc C√¥ng ngh·ªá Th√¥ng tin v√† Truy·ªÅn th√¥ng. B·∫°n c√≥ th·ªÉ h·ªèi v·ªÅ ƒëi·ªÅu ki·ªán, quy tr√¨nh x√©t duy·ªát, m·ª©c h·ªçc b·ªïng v√† nhi·ªÅu th√¥ng tin kh√°c.', isBot: true, disableRating: true };
                    messagesContainer.appendChild(createMessageElement(initialMessage));
                }
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                lucide.createIcons();
            } catch (error) {
                console.error('L·ªói khi l·∫•y l·ªãch s·ª≠:', error);
                const errorMessage = { text: `L·ªói khi t·∫£i l·ªãch s·ª≠: ${error.message}`, isBot: true };
                messagesContainer.appendChild(createMessageElement(errorMessage));
                lucide.createIcons();
            }
        }

        // H√†m t·∫°o tin nh·∫Øn
        function createMessageElement(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.isBot ? 'bot' : 'user'}`;

            const avatarDiv = document.createElement('div');
            avatarDiv.className = `message-avatar ${message.isBot ? 'bot-avatar' : 'user-avatar'}`;

            const icon = document.createElement('i');
            icon.setAttribute('data-lucide', message.isBot ? 'bot' : 'user');
            avatarDiv.appendChild(icon);

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = message.text;

            contentDiv.appendChild(textDiv);

            // Add rating buttons for bot messages
            if (message.isBot && !message.disableRating) {
                const ratingDiv = document.createElement('div');
                ratingDiv.className = 'rating-buttons';

                const goodButton = createRatingButton('ƒê·∫°t', 'rating-good', 'thumbs-up');
                const fairButton = createRatingButton('T·∫°m', 'rating-fair', 'meh');
                const poorButton = createRatingButton('Kh√¥ng ƒë·∫°t', 'rating-poor', 'thumbs-down');

                const commentDiv = document.createElement('div');
                commentDiv.className = 'rating-comment';

                const commentInput = document.createElement('textarea');
                commentInput.className = 'rating-comment-input';
                commentInput.placeholder = 'Nh·∫≠p ƒë√°nh gi√° c·ªßa b·∫°n...';
                commentInput.rows = 1;

                const submitButton = document.createElement('button');
                submitButton.className = 'rating-submit';
                submitButton.disabled = true;
                const submitIcon = document.createElement('i');
                submitIcon.setAttribute('data-lucide', 'send');
                submitButton.appendChild(submitIcon);

                commentDiv.appendChild(commentInput);
                commentDiv.appendChild(submitButton);

                ratingDiv.appendChild(goodButton);
                ratingDiv.appendChild(fairButton);
                ratingDiv.appendChild(poorButton);
                ratingDiv.appendChild(commentDiv);

                contentDiv.appendChild(ratingDiv);

                // Add hover effect to show rating buttons
                contentDiv.addEventListener('mouseenter', () => {
                    ratingDiv.classList.add('active');
                });

                contentDiv.addEventListener('mouseleave', () => {
                    if (!ratingDiv.querySelector('.rating-feedback')) {
                        ratingDiv.classList.remove('active');
                    }
                });
            }

            messageDiv.appendChild(avatarDiv);
            messageDiv.appendChild(contentDiv);

            return messageDiv;
        }

        function createRatingButton(text, className, iconName) {
            const button = document.createElement('button');
            button.className = `rating-button ${className}`;
            button.setAttribute('data-tooltip', text);

            const icon = document.createElement('i');
            icon.setAttribute('data-lucide', iconName);
            button.appendChild(icon);

            button.addEventListener('click', () => {
                const messageDiv = button.closest('.message');
                const ratingDiv = messageDiv.querySelector('.rating-buttons');
                const commentDiv = messageDiv.querySelector('.rating-comment');

                // Make sure rating stays visible
                ratingDiv.classList.add('active');
                commentDiv.classList.add('active');

                const rating = text;

                // Remove highlight from all buttons
                const buttons = messageDiv.querySelectorAll('.rating-button');
                buttons.forEach(btn => {
                    btn.disabled = false;
                    btn.style.opacity = '';
                    btn.style.transform = '';
                    btn.classList.remove('selected');
                });

                // Highlight selected button
                button.classList.add('selected');

                // Store selected rating in a data attribute for later use
                ratingDiv.setAttribute('data-selected-rating', rating);

                // Enable submit button
                const submitButton = messageDiv.querySelector('.rating-submit');
                submitButton.disabled = false;
            });

            return button;
        }

        // Add this function to handle comment submission
        function handleRatingSubmit(messageDiv) {
            const ratingDiv = messageDiv.querySelector('.rating-buttons');
            const commentDiv = messageDiv.querySelector('.rating-comment');
            const rating = ratingDiv.getAttribute('data-selected-rating');

            if (!rating) return; // No rating selected

            const commentInput = messageDiv.querySelector('.rating-comment-input');
            const comment = commentInput.value.trim();

            // Mark as submitted to change display behavior
            ratingDiv.classList.remove('active');
            ratingDiv.classList.add('submitted');
            commentDiv.classList.remove('active');
            commentDiv.classList.add('submitted');

            // Only disable inputs after submit
            const buttons = messageDiv.querySelectorAll('.rating-button');
            buttons.forEach(btn => {
                btn.disabled = true;
                if (!btn.classList.contains('selected')) {
                    btn.style.display = 'none';
                }
            });

            commentInput.disabled = true;
            const submitButton = messageDiv.querySelector('.rating-submit');
            submitButton.disabled = true;
            submitButton.style.display = 'none';

            // Add feedback text
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'rating-feedback';

            const feedbackText = document.createElement('div');
            feedbackText.className = 'rating-feedback-text';
            feedbackText.textContent = `ƒê√£ ƒë√°nh gi√°: ${rating}${comment ? ` - ${comment}` : ''}`;

            const feedbackIcon = document.createElement('i');
            feedbackIcon.setAttribute('data-lucide', 'check-circle');
            feedbackIcon.style.color = '#4ade80';

            feedbackDiv.appendChild(feedbackIcon);
            feedbackDiv.appendChild(feedbackText);

            // Remove any existing feedback
            const existingFeedback = messageDiv.querySelector('.rating-feedback');
            if (existingFeedback) {
                existingFeedback.remove();
            }

            messageDiv.querySelector('.rating-buttons').appendChild(feedbackDiv);
            lucide.createIcons(feedbackDiv);

            // Send rating to server
            sendRatingToServer(messageDiv, rating, comment);
        }

        // Function to handle click outside the rating area
        document.addEventListener('click', (e) => {
            // If clicked on submit button, don't hide the rating
            if (e.target.closest('.rating-submit')) {
                return;
            }

            // Check if click is outside a rating area
            if (!e.target.closest('.rating-buttons') && !e.target.closest('.rating-comment')) {
                // Get all active rating sections
                const activeRatings = document.querySelectorAll('.rating-buttons.active');
                const activeComments = document.querySelectorAll('.rating-comment.active');

                activeRatings.forEach(rating => {
                    const commentDiv = rating.closest('.message-content').querySelector('.rating-comment');
                    const commentInput = commentDiv.querySelector('.rating-comment-input');

                    // Only hide if comment input is empty
                    if (!commentInput.value.trim()) {
                        rating.classList.remove('active');
                        commentDiv.classList.remove('active');
                    }
                });
            }
        });

        // Add event listener for the textarea to keep rating visible
        document.addEventListener('focusin', (e) => {
            if (e.target.classList.contains('rating-comment-input')) {
                const messageDiv = e.target.closest('.message');
                const ratingDiv = messageDiv.querySelector('.rating-buttons');
                const commentDiv = messageDiv.querySelector('.rating-comment');

                // Make sure rating stays visible
                ratingDiv.classList.add('active');
                commentDiv.classList.add('active');
            }
        });

        // H√†m t·∫°o n√∫t c√¢u h·ªèi li√™n quan (THI·∫æU TRONG CODE HI·ªÜN T·∫†I)
        function createRelatedQuestionButton(question) {
            const button = document.createElement('button');
            button.className = 'related-button';

            const icon = document.createElement('i');
            icon.setAttribute('data-lucide', 'calendar');
            button.appendChild(icon);

            const text = document.createTextNode(question);
            button.appendChild(text);

            button.addEventListener('click', () => {
                document.getElementById('message-input').value = question;
            });

            return button;
        }

        // H√†m t·∫°o th√¥ng b√°o "ƒêang x·ª≠ l√Ω"
        function createLoadingMessage() {
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message bot';
            const avatarDiv = document.createElement('div');
            avatarDiv.className = 'message-avatar bot-avatar';
            const icon = document.createElement('i');
            icon.setAttribute('data-lucide', 'bot');
            avatarDiv.appendChild(icon);
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            const textDiv = document.createElement('div');
            textDiv.className = 'message-text';
            textDiv.textContent = 'ƒêang x·ª≠ l√Ω...';
            contentDiv.appendChild(textDiv);
            const timerSpan = document.createElement('span');
            timerSpan.id = 'loading-timer';
            timerSpan.textContent = ' (0s)';
            textDiv.appendChild(timerSpan);
            loadingDiv.appendChild(avatarDiv);
            loadingDiv.appendChild(contentDiv);
            return loadingDiv;
        }

        function startTimer(loadingElement) {
            let seconds = 0;
            const timer = setInterval(() => {
                seconds++;
                const timerSpan = loadingElement.querySelector('#loading-timer');
                if (timerSpan) timerSpan.textContent = ` (${seconds}s)`;
            }, 1000);
            return timer;
        }

        function updateSessionList() {
            const sessionList = document.getElementById('session-list');
            sessionList.innerHTML = '';
            sessions.forEach(sessionId => {
                const displayName = sessionNames[sessionId] || sessionId;
                const sessionItem = document.createElement('div');
                sessionItem.className = 'session-item';
                if (sessionId === userId) {
                    sessionItem.classList.add('selected');
                }
                const sessionName = document.createElement('span');
                sessionName.className = 'session-name';
                sessionName.textContent = displayName;
                sessionName.addEventListener('click', () => {
                    userId = sessionId;
                    saveActive(sessionId);
                    updateSessionList();
                    loadSessionHistoryIntoChat();
                });
                const renameButton = document.createElement('button');
                renameButton.className = 'rename-session';
                renameButton.textContent = '‚úé';
                renameButton.title = 'ƒê·ªïi t√™n cu·ªôc tr√≤ truy·ªán';
                renameButton.addEventListener('click', async () => {
                    const newName = prompt('Nh·∫≠p t√™n m·ªõi cho cu·ªôc tr√≤ truy·ªán:', displayName);
                    if (newName) {
                        await fetch('/set_session_name', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user_id: sessionId, name: newName })
                        });
                        sessionNames[sessionId] = newName;
                        localStorage.setItem('sessionNames', JSON.stringify(sessionNames));
                        updateSessionList();
                    }
                });
                const deleteButton = document.createElement('button');
                deleteButton.className = 'delete-session';
                deleteButton.textContent = 'üóë';
                deleteButton.title = 'X√≥a cu·ªôc tr√≤ truy·ªán';
                deleteButton.addEventListener('click', async () => {
                    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a phi√™n ${displayName}?`)) {
                        await fetch('/clear_session', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ user_id: sessionId })
                        });
                        sessions = sessions.filter(id => id !== sessionId);
                        delete sessionNames[sessionId];
                        localStorage.setItem('sessions', JSON.stringify(sessions));
                        localStorage.setItem('sessionNames', JSON.stringify(sessionNames));
                        if (userId === sessionId) {
                            userId = sessions[0] || (await fetch('/get_user_id').then(res => res.json())).user_id;
                            if (!sessions.includes(userId)) {
                                sessions.unshift(userId);
                                localStorage.setItem('sessions', JSON.stringify(sessions));
                            }
                            saveActive(userId);
                        }
                        updateSessionList();
                        loadSessionHistoryIntoChat(userId);
                    }
                });
                sessionItem.appendChild(sessionName);
                sessionItem.appendChild(renameButton);
                sessionItem.appendChild(deleteButton);
                sessionList.appendChild(sessionItem);
            });
        }

        // Ch·ªù userId tr∆∞·ªõc khi th√™m s·ª± ki·ªán
        initializeUserId().then(() => {
            const saved = getActive();
            if (saved && sessions.includes(saved)) userId = saved;
            else if (!sessions.includes(userId)) userId = sessions[0];
            updateSessionList();
            loadSessionHistoryIntoChat();

            document.getElementById('new-session').addEventListener('click', async () => {
                try {
                    const response = await fetch('/get_user_id');
                    const data = await response.json();
                    userId = data.user_id;
                    sessions.unshift(userId);              // NEW ‚Äì th√™m ƒë·∫ßu m·∫£ng
                    saveActive(userId);
                    localStorage.setItem('sessions', JSON.stringify(sessions));
                    updateSessionList();
                    // T·∫£i l·ªãch s·ª≠ c·ªßa phi√™n m·ªõi (s·∫Ω l√† r·ªóng v√¨ phi√™n m·ªõi)
                    loadSessionHistoryIntoChat();
                } catch (error) {
                    console.error('L·ªói khi t·∫°o phi√™n m·ªõi:', error);
                }
            });

            document.getElementById('chat-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const input = document.getElementById('message-input');
                const message = input.value.trim();
                if (message) {
                    const userMessage = { text: message, isBot: false };
                    messagesContainer.appendChild(createMessageElement(userMessage));
                    input.value = '';

                    // T·∫°o tin nh·∫Øn bot tr·ªëng ƒë·ªÉ c·∫≠p nh·∫≠t d·∫ßn, ·∫®N khung ƒë√°nh gi√° khi ƒëang stream
                    const botMessage = { text: '', isBot: true, disableRating: true };
                    const botMessageElement = createMessageElement(botMessage);
                    messagesContainer.appendChild(botMessageElement);
                    lucide.createIcons(botMessageElement);
                    const botTextElement = botMessageElement.querySelector('.message-text');
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;

                    try {
                        // S·ª≠ d·ª•ng EventSource ƒë·ªÉ nh·∫≠n streaming response
                        const eventSource = new EventSource(`/ask?query=${encodeURIComponent(message)}&user_id=${userId}&stream=true`);
                        let fullResponse = '';

                        eventSource.onmessage = (event) => {
                            const data = JSON.parse(event.data);
                            if (data.content) {
                                fullResponse += data.content;
                                botTextElement.textContent = fullResponse;
                                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                            }
                        };

                        eventSource.addEventListener('done', (event) => {
                            const data = JSON.parse(event.data);
                            if (data.full_response) {
                                fullResponse = data.full_response;
                                botTextElement.textContent = fullResponse;
                            }
                            eventSource.close();
                            // Khi stream xong, HI·ªÜN khung ƒë√°nh gi√° cho message bot cu·ªëi c√πng
                            // X√≥a message bot c≈© v√† render l·∫°i v·ªõi disableRating: false
                            const lastBotMsg = messagesContainer.lastElementChild;
                            if (lastBotMsg && lastBotMsg.classList.contains('bot')) {
                                // L∆∞u l·∫°i text
                                const text = lastBotMsg.querySelector('.message-text').textContent;
                                // T·∫°o l·∫°i message bot v·ªõi disableRating: false
                                const newBotMsg = createMessageElement({ text, isBot: true });
                                messagesContainer.replaceChild(newBotMsg, lastBotMsg);
                                lucide.createIcons();
                            }
                        });

                        eventSource.onerror = (error) => {
                            console.error('EventSource error:', error);
                            botTextElement.textContent = 'ƒê√£ x·∫£y ra l·ªói khi nh·∫≠n ph·∫£n h·ªìi. Vui l√≤ng th·ª≠ l·∫°i.';
                            eventSource.close();
                            lucide.createIcons();
                        };

                    } catch (error) {
                        console.error('L·ªói khi g·ª≠i tin nh·∫Øn:', error);
                        botTextElement.textContent = 'ƒê√£ x·∫£y ra l·ªói. Vui l√≤ng th·ª≠ l·∫°i sau.';
                        lucide.createIcons();
                    }
                }
            });

            const initialMessages = [
                { text: 'ICTU xin ch√†o! T√¥i c√≥ th·ªÉ gi√∫p b·∫°n tr·∫£ l·ªùi c√°c c√¢u h·ªèi v·ªÅ h·ªçc b·ªïng, quy ƒë·ªãnh t·∫°i tr∆∞·ªùng ƒê·∫°i h·ªçc C√¥ng ngh·ªá Th√¥ng tin v√† Truy·ªÅn th√¥ng. B·∫°n c√≥ th·ªÉ h·ªèi v·ªÅ ƒëi·ªÅu ki·ªán, quy tr√¨nh x√©t duy·ªát, m·ª©c h·ªçc b·ªïng v√† nhi·ªÅu th√¥ng tin kh√°c.', isBot: true, disableRating: true }
            ];
            const relatedQuestions = [
                'H·ªçc b·ªïng khuy·∫øn kh√≠ch h·ªçc t·∫≠p l√† g√¨?',
                'Quy ƒë·ªãnh v·ªÅ ng∆∞·ªùi h·ªçc tr√™n gi·∫£ng ƒë∆∞·ªùng?',
                'Quy ƒë·ªãnh v·ªÅ k·ª∑ c∆∞∆°ng c·ªßa gi·∫£ng vi√™n tr√™n gi·∫£ng ƒë∆∞·ªùng?',
                'Y√™u c·∫ßu khi mu·ªën chuy·ªÉn ng√†nh?',
                'C√°c th√¥ng tin v·ªÅ gi·∫£ng d·∫°y?',
                'Quy ƒë·ªãnh h·ªçc hai vƒÉn b·∫±ng?',
            ];

            initialMessages.forEach(message => messagesContainer.appendChild(createMessageElement(message)));
            if (messagesContainer.children.length === 0) {
                initialMessages.forEach(m => messagesContainer.appendChild(createMessageElement(m)));
            }
            relatedQuestions.forEach(question => relatedQuestionsContainer.appendChild(createRelatedQuestionButton(question)));
            lucide.createIcons();
        }).catch(error => {
            console.error('L·ªói khi kh·ªüi t·∫°o userId:', error);
            const errorMessage = { text: 'Kh√¥ng th·ªÉ kh·ªüi t·∫°o phi√™n l√†m vi·ªác. Vui l√≤ng th·ª≠ l·∫°i sau.', isBot: true };
            messagesContainer.appendChild(createMessageElement(errorMessage));
            lucide.createIcons();
        });

        async function sendRatingToServer(messageDiv, rating, comment) {
            try {
                const response = await fetch('/rate_response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        rating: rating,
                        comment: comment,
                        question: messageDiv.previousElementSibling?.querySelector('.message-text')?.textContent || '',
                        answer: messageDiv.querySelector('.message-text').textContent
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to save rating');
                }
            } catch (error) {
                console.error('Error saving rating:', error);
                const feedbackDiv = messageDiv.querySelector('.rating-feedback');
                if (feedbackDiv) {
                    feedbackDiv.querySelector('.rating-feedback-text').textContent = 'L·ªói khi l∆∞u ƒë√°nh gi√°';
                }
            }
        }

        // Add auto-resize for comment textarea
        document.addEventListener('input', (e) => {
            if (e.target.classList.contains('rating-comment-input')) {
                e.target.style.height = 'auto';
                e.target.style.height = (e.target.scrollHeight) + 'px';
            }
        });

        // Add event listener for submit buttons
        document.addEventListener('click', (e) => {
            if (e.target.closest('.rating-submit')) {
                const messageDiv = e.target.closest('.message');
                handleRatingSubmit(messageDiv);
            }
        });

        // Th√™m ch·ª©c nƒÉng chuy·ªÉn ƒë·ªïi dark/light mode
        const toggleModeBtn = document.getElementById('toggle-mode-btn');
        const toggleModeIcon = document.getElementById('toggle-mode-icon');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        // L∆∞u ch·∫ø ƒë·ªô v√†o localStorage
        function setMode(mode) {
            if (mode === 'light') {
                document.body.classList.add('light-mode');
                document.body.classList.remove('dark-mode');
                toggleModeIcon.setAttribute('data-lucide', 'moon');
            } else {
                document.body.classList.remove('light-mode');
                document.body.classList.add('dark-mode');
                toggleModeIcon.setAttribute('data-lucide', 'sun');
            }
            lucide.createIcons();
            // ƒê·∫£m b·∫£o c·∫≠p nh·∫≠t m√†u icon ngay l·∫≠p t·ª©c
            if (mode === 'dark') {
                toggleModeIcon.style.color = '#facc15';
                toggleModeIcon.style.filter = 'drop-shadow(0 0 4px #fde68a)';
            } else {
                toggleModeIcon.style.color = '#64748b';
                toggleModeIcon.style.filter = '';
            }
            localStorage.setItem('color-mode', mode);
        }
        // ƒê·∫£m b·∫£o icon ƒë√∫ng m√†u khi load l·∫°i
        function updateToggleIconColor() {
            if (document.body.classList.contains('dark-mode')) {
                toggleModeIcon.style.color = '#facc15';
                toggleModeIcon.style.filter = 'drop-shadow(0 0 4px #fde68a)';
            } else {
                toggleModeIcon.style.color = '#64748b';
                toggleModeIcon.style.filter = '';
            }
        }
        // Kh·ªüi t·∫°o ch·∫ø ƒë·ªô
        const savedMode = localStorage.getItem('color-mode');
        if (savedMode) {
            setMode(savedMode);
        } else {
            setMode(prefersDark ? 'dark' : 'light');
        }
        toggleModeBtn.addEventListener('click', () => {
            if (document.body.classList.contains('light-mode')) {
                setMode('dark');
            } else {
                setMode('light');
            }
            updateToggleIconColor();
        });
        // ƒê·∫£m b·∫£o icon ƒë√∫ng m√†u khi load l·∫°i
        updateToggleIconColor();
    </script>
</body>

</html>